{% comment %}
  Renders related content for an expertise domain based on YAML mapping
  Usage: {% include expertise-related.html expertise_id='prestashop' %}
  Data source: _data/expertise_map.yml
{% endcomment %}

{% assign map = site.data.expertise_map[include.expertise_id] %}
{% if map %}
  {% assign related = '' | split: '' %}

  {% if map.categories %}
    {% for cat in map.categories %}
      {% assign found_cat = site.posts | where_exp: 'p', 'p.categories contains cat' %}
      {% assign related = related | concat: found_cat %}
    {% endfor %}
  {% endif %}

  {% if map.tags %}
    {% for tg in map.tags %}
      {% assign found_tag = site.posts | where_exp: 'p', 'p.tags contains tg' %}
      {% assign related = related | concat: found_tag %}
    {% endfor %}
  {% endif %}

  {% assign related = related | uniq %}
  {% assign related = related | sort: 'date' | reverse %}

  {% comment %} Exclure les articles futurs et les posts LinkedIn {% endcomment %}
  {% assign filtered_related = '' | split: '' %}
  {% assign now_timestamp = site.time | date: "%s" %}
  {% for post in related %}
    {% assign post_timestamp = post.date | date: "%s" %}
    {% if post_timestamp <= now_timestamp and post.linkedin != true %}
      {% assign filtered_related = filtered_related | push: post %}
    {% endif %}
  {% endfor %}
  {% assign related = filtered_related %}

  {% if related and related.size > 0 %}
    <div class="expertise-card">
      <h3>Articles li√©s</h3>
      <ul class="expertise-list-compact">
        {% for post in related limit: 6 %}
          <li><a href="{{ post.url | relative_url }}">{{ post.title }}</a></li>
        {% endfor %}
      </ul>
      <div class="expertise-cta">
        <a class="btn btn--secondary" href="/blog/">Tous les articles</a>
      </div>
    </div>
  {% else %}
    <p>Aucun article disponible pour le moment.</p>
  {% endif %}
{% endif %}


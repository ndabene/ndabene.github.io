{% comment %}
Système de maillage interne intelligent pour SEO/GEO

Suggère automatiquement des articles liés basés sur:
- Tags communs
- Catégories similaires
- Technologies partagées
- Séries d'articles

Usage: {% include smart-internal-links.html %}
{% endcomment %}

{% assign current_post = page %}
{% assign related_posts = "" | split: "" %}
{% assign max_related = 6 %}

{% comment %} Trouver les articles liés par tags, catégories et technologies {% endcomment %}
{% for post in site.posts %}
{% comment %} Exclure le post actuel et les articles futurs {% endcomment %}
{% assign post_timestamp = post.date | date: "%s" %}
{% assign now_timestamp = site.time | date: "%s" %}
{% if post.url != current_post.url and post_timestamp <= now_timestamp %} {% assign score=0 %} {% comment %} Score par
  tags communs (poids: 3) {% endcomment %} {% if current_post.tags and post.tags %} {% for tag in current_post.tags %}
  {% if post.tags contains tag %} {% assign score=score | plus: 3 %} {% endif %} {% endfor %} {% endif %} {% comment %}
  Score par catégories communes (poids: 5) {% endcomment %} {% if current_post.categories and post.categories %} {% for
  category in current_post.categories %} {% if post.categories contains category %} {% assign score=score | plus: 5 %}
  {% endif %} {% endfor %} {% endif %} {% comment %} Score par technologies communes (poids: 4) {% endcomment %} {% if
  current_post.technologies and post.technologies %} {% for tech in current_post.technologies %} {% if post.technologies
  contains tech %} {% assign score=score | plus: 4 %} {% endif %} {% endfor %} {% endif %} {% comment %} Bonus pour
  articles récents (poids: 2 si < 60 jours) {% endcomment %} {% assign days_diff=site.time | date: "%s" | minus:
  post.date | date: "%s" | divided_by: 86400 %} {% if days_diff < 60 %} {% assign score=score | plus: 2 %} {% endif %}
  {% comment %} Bonus pour articles featured (poids: 3) {% endcomment %} {% if post.featured %} {% assign score=score |
  plus: 3 %} {% endif %} {% comment %} Si score> 3, ajouter à la liste {% endcomment %}
  {% if score > 3 %}
  {% assign post_with_score = post.url | append: "|" | append: score %}
  {% assign related_posts = related_posts | push: post_with_score %}
  {% endif %}
  {% endif %}
  {% endfor %}

  {% comment %} Trier par score (simulation simple - prendre les meilleurs) {% endcomment %}
  {% assign sorted_related = related_posts | sort | reverse %}

  {% if sorted_related.size > 0 %}
  <section class="smart-internal-links" data-pagefind-ignore>
    <h2 class="links-title">
      <i class="fas fa-link"></i>
      Articles Liés
    </h2>

    <div class="links-grid">
      {% assign count = 0 %}
      {% for item in sorted_related limit: max_related %}
      {% assign post_url = item | split: "|" | first %}
      {% assign post_score = item | split: "|" | last %}

      {% comment %} Trouver le post correspondant {% endcomment %}
      {% for post in site.posts %}
      {% if post.url == post_url and count < max_related %} {% assign count=count | plus: 1 %} <article
        class="link-card" itemscope itemtype="https://schema.org/Article">
        {% if post.image %}
        <div class="link-image">
          <a href="{{ post.url }}" title="{{ post.title }}">
            {% include responsive-image.html
            src=post.image
            alt=post.title
            loading="lazy"
            width="400"
            height="250"
            %}
          </a>
          {% if post.featured %}
          <span class="link-badge featured">
            <i class="fas fa-star"></i>
            Featured
          </span>
          {% endif %}
        </div>
        {% endif %}

        <div class="link-content">
          <h3 class="link-title" itemprop="headline">
            <a href="{{ post.url }}" title="{{ post.title }}">
              {{ post.title }}
            </a>
          </h3>

          {% if post.excerpt %}
          <p class="link-excerpt" itemprop="description">
            {{ post.excerpt | strip_html | truncate: 120 }}
          </p>
          {% endif %}

          <div class="link-meta">
            <time datetime="{{ post.date | date_to_xmlschema }}" itemprop="datePublished">
              <i class="fas fa-calendar-alt"></i>
              {{ post.date | date: "%d/%m/%Y" }}
            </time>

            {% if post.estimated_reading_time %}
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              {{ post.estimated_reading_time }}
            </span>
            {% endif %}
          </div>

          {% comment %} Schema.org author metadata {% endcomment %}
          {% if post.author %}
          <span itemprop="author" itemscope itemtype="https://schema.org/Person" style="display: none;">
            <span itemprop="name">{{ post.author }}</span>
          </span>
          {% endif %}

          {% if post.tags and post.tags.size > 0 %}
          <div class="link-tags">
            {% for tag in post.tags limit: 3 %}
            <span class="link-tag">{{ tag }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        </article>
        {% endif %}
        {% endfor %}
        {% endfor %}
    </div>
  </section>

  <style>
    .smart-internal-links {
      margin: 3rem 0;
      padding: 2rem 0;
      border-top: 2px solid #e9ecef;
    }

    .links-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 2rem;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .links-title i {
      color: #007bff;
    }

    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 2rem;
    }

    .link-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .link-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      transform: translateY(-4px);
    }

    .link-image {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .link-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .link-card:hover .link-image img {
      transform: scale(1.05);
    }

    .link-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
    }

    .link-content {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .link-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }

    .link-title a {
      color: #2c3e50;
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .link-title a:hover {
      color: #007bff;
    }

    .link-excerpt {
      color: #6c757d;
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 1rem;
      flex: 1;
    }

    .link-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.75rem;
    }

    .link-meta i {
      color: #007bff;
    }

    .link-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .link-tag {
      background: #f1f3f5;
      color: #495057;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .link-tag:hover {
      background: #007bff;
      color: white;
    }

    @media (max-width: 768px) {
      .links-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .smart-internal-links {
        padding: 1.5rem 0;
      }

      .link-image {
        height: 160px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .links-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  {% endif %}
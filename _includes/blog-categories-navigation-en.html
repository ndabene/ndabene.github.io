{% comment %}
Category navigation for the blog page - Classic horizontal navbar version
Displays main categories in a horizontal bar with tabs
{% endcomment %}

<section class="blog-categories-navbar">
    <div class="categories-nav-container">
        <!-- "All articles" tab -->
        <button class="category-tab active" data-category="all">
            <i class="fas fa-th"></i>
            <span>All articles</span>
            <span class="tab-count">{{ include.posts.size }}</span>
        </button>

        <!-- Category tabs -->
        {% for category_item in site.data.blog_categories_en %}
            {% assign category_key = category_item[0] %}
            {% assign category = category_item[1] %}

            {% comment %}Count articles in this category{% endcomment %}
            {% assign category_posts_count = 0 %}
            {% for post in include.posts %}
                {% if post.category == category_key %}
                    {% assign category_posts_count = category_posts_count | plus: 1 %}
                {% endif %}
            {% endfor %}

            {% if category_posts_count > 0 %}
            <button class="category-tab"
                    data-category="{{ category_key }}"
                    data-has-subcategories="{% if category.subcategories and category.subcategories.size > 0 %}true{% else %}false{% endif %}">
                <i class="fas {{ category.icon }}"></i>
                <span>{{ category.name }}</span>
                <span class="tab-count">{{ category_posts_count }}</span>
            </button>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Subcategories (displayed when a category is selected) -->
    <div class="subcategories-bar" id="subcategories-bar" style="display: none;">
        <div class="subcategories-container">
            <button class="subcategory-btn active" data-subcategory="all">
                All subcategories
            </button>

            {% for category_item in site.data.blog_categories_en %}
                {% assign category_key = category_item[0] %}
                {% assign category = category_item[1] %}

                {% if category.subcategories and category.subcategories.size > 0 %}
                <div class="subcategories-group" data-parent-category="{{ category_key }}" style="display: none;">
                    {% for subcategory in category.subcategories %}
                        {% comment %}Count articles in this subcategory{% endcomment %}
                        {% assign subcat_posts_count = 0 %}
                        {% for post in include.posts %}
                            {% if post.subcategory == subcategory.key and post.category == category_key %}
                                {% assign subcat_posts_count = subcat_posts_count | plus: 1 %}
                            {% endif %}
                        {% endfor %}

                        {% if subcat_posts_count > 0 %}
                        <button class="subcategory-btn"
                                data-subcategory="{{ subcategory.key }}"
                                title="{{ subcategory.description }}">
                            {{ subcategory.name }} <span class="sub-count">({{ subcat_posts_count }})</span>
                        </button>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Active filter badge -->
    <div class="active-filter-badge" id="active-filter-badge" style="display: none;">
        <span class="filter-text">
            <i class="fas fa-filter"></i>
            <span id="filter-text-content"></span>
        </span>
        <button class="clear-filter-btn" id="clear-filter-btn">
            <i class="fas fa-times"></i> Reset
        </button>
    </div>
</section>

<style>
.blog-categories-navbar {
    background: #fff;
    border-bottom: 2px solid #e5e7eb;
    margin: 2rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.categories-nav-container {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 0.5rem;
    padding: 1rem;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.categories-nav-container::-webkit-scrollbar {
    height: 6px;
}

.categories-nav-container::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.categories-nav-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.category-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: #f9fafb;
    border: 2px solid transparent;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
}

.category-tab:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.category-tab.active {
    background: var(--primary-color, #2c5aa0);
    color: white;
    border-color: var(--primary-color, #2c5aa0);
}

.category-tab i {
    font-size: 1rem;
}

.tab-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 0.5rem;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.category-tab.active .tab-count {
    background: rgba(255, 255, 255, 0.25);
}

.subcategories-bar {
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
}

.subcategories-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.subcategories-group {
    display: contents;
}

.subcategory-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

.subcategory-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.subcategory-btn.active {
    background: var(--primary-color, #2c5aa0);
    color: white;
    border-color: var(--primary-color, #2c5aa0);
}

.sub-count {
    font-size: 0.75rem;
    opacity: 0.75;
}

.active-filter-badge {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: #eff6ff;
    border-top: 1px solid #bfdbfe;
}

.filter-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e40af;
}

.filter-text i {
    color: #3b82f6;
}

.clear-filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e40af;
    cursor: pointer;
    transition: all 0.2s ease;
}

.clear-filter-btn:hover {
    background: #f0f9ff;
    border-color: #3b82f6;
}

.clear-filter-btn i {
    color: #ef4444;
}

@media (max-width: 768px) {
    .category-tab {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
    }

    .subcategory-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }
}
</style>

<script>
// Category navigation and filtering management
(function() {
    'use strict';

    // Wait for DOM to be loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCategoryNavigation);
    } else {
        initCategoryNavigation();
    }

    function initCategoryNavigation() {
        const categoryTabs = document.querySelectorAll('.category-tab');
        const subcategoriesBar = document.getElementById('subcategories-bar');
        const subcategoryBtns = document.querySelectorAll('.subcategory-btn');
        const activeFilterBadge = document.getElementById('active-filter-badge');
        const filterTextContent = document.getElementById('filter-text-content');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const postsContainer = document.getElementById('blog-posts-container');

        let currentCategory = 'all';
        let currentSubcategory = 'all';

        // Handle category tabs click
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const category = this.dataset.category;
                const hasSubcategories = this.dataset.hasSubcategories === 'true';

                // Update active tab
                categoryTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show/hide subcategories bar
                if (category === 'all') {
                    subcategoriesBar.style.display = 'none';
                    resetFilters();
                } else {
                    currentCategory = category;
                    currentSubcategory = 'all';

                    if (hasSubcategories) {
                        showSubcategories(category);
                    } else {
                        subcategoriesBar.style.display = 'none';
                    }

                    filterPosts(category, 'all');
                }
            });
        });

        // Handle subcategories click
        subcategoryBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const subcategory = this.dataset.subcategory;

                // Update active button
                const parentGroup = this.closest('.subcategories-group');
                if (parentGroup) {
                    parentGroup.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                } else {
                    document.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                }
                this.classList.add('active');

                currentSubcategory = subcategory;
                filterPosts(currentCategory, subcategory);
            });
        });

        // Handle reset button
        if (clearFilterBtn) {
            clearFilterBtn.addEventListener('click', resetFilters);
        }

        // Show subcategories for a category
        function showSubcategories(category) {
            // Hide all subcategory groups
            document.querySelectorAll('.subcategories-group').forEach(group => {
                group.style.display = 'none';
            });

            // Show corresponding group
            const targetGroup = document.querySelector(`.subcategories-group[data-parent-category="${category}"]`);
            if (targetGroup) {
                targetGroup.style.display = 'contents';
                subcategoriesBar.style.display = 'block';

                // Reset "All subcategories" button
                const allSubBtn = document.querySelector('.subcategory-btn[data-subcategory="all"]');
                if (allSubBtn) {
                    document.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                    allSubBtn.classList.add('active');
                }
            }
        }

        // Filter posts
        function filterPosts(category, subcategory) {
            if (!postsContainer) return;

            const posts = postsContainer.querySelectorAll('.post-preview-wrapper, article.post-preview-news');
            let visibleCount = 0;

            posts.forEach(post => {
                // Find article element inside if needed
                const articleElement = post.classList.contains('post-preview-news')
                    ? post
                    : post.querySelector('.post-preview-news');

                if (!articleElement) {
                    post.style.display = 'none';
                    return;
                }

                const postCategory = articleElement.dataset.category || '';
                const postSubcategory = articleElement.dataset.subcategory || '';

                let shouldShow = false;

                if (category === 'all') {
                    shouldShow = true;
                } else if (subcategory === 'all') {
                    shouldShow = postCategory === category;
                } else {
                    shouldShow = postCategory === category && postSubcategory === subcategory;
                }

                if (shouldShow) {
                    post.style.display = '';
                    visibleCount++;
                } else {
                    post.style.display = 'none';
                }
            });

            // Update filter badge
            updateFilterBadge(category, subcategory, visibleCount);

            // Update counter
            updateCounter(visibleCount);

            // Handle "no results" message
            showNoResults(visibleCount === 0);
        }

        // Update active filter badge
        function updateFilterBadge(category, subcategory, count) {
            if (category === 'all') {
                activeFilterBadge.style.display = 'none';
                return;
            }

            const categoryTab = document.querySelector(`.category-tab[data-category="${category}"]`);
            const categoryName = categoryTab ? categoryTab.querySelector('span:not(.tab-count)').textContent : category;

            let filterText = `${categoryName}`;

            if (subcategory !== 'all') {
                const subcatBtn = document.querySelector(`.subcategory-btn[data-subcategory="${subcategory}"]`);
                const subcatName = subcatBtn ? subcatBtn.textContent.replace(/\(\d+\)/, '').trim() : subcategory;
                filterText += ` â†’ ${subcatName}`;
            }

            filterText += ` (${count} article${count > 1 ? 's' : ''})`;

            filterTextContent.textContent = filterText;
            activeFilterBadge.style.display = 'flex';
        }

        // Update article counter
        function updateCounter(count) {
            const countElement = document.getElementById('filtered-count');
            if (countElement) {
                countElement.textContent = `(${count})`;
            }
        }

        // Show/hide "no results" message
        function showNoResults(show) {
            const noResults = document.getElementById('no-results');
            if (noResults) {
                noResults.style.display = show ? 'block' : 'none';
            }
        }

        // Reset all filters
        function resetFilters() {
            currentCategory = 'all';
            currentSubcategory = 'all';

            // Reactivate "All articles" tab
            categoryTabs.forEach(t => t.classList.remove('active'));
            const allTab = document.querySelector('.category-tab[data-category="all"]');
            if (allTab) {
                allTab.classList.add('active');
            }

            // Hide subcategories bar
            subcategoriesBar.style.display = 'none';

            // Show all articles
            if (postsContainer) {
                const posts = postsContainer.querySelectorAll('.post-preview-wrapper, article.post-preview-news');
                posts.forEach(post => {
                    post.style.display = '';
                });

                updateCounter(posts.length);
            }

            // Hide filter badge
            activeFilterBadge.style.display = 'none';

            // Hide "no results" message
            showNoResults(false);
        }

        // Link with existing "Reset filters" button
        const resetFiltersBtn = document.getElementById('reset-filters');
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', resetFilters);
        }
    }
})();
</script>

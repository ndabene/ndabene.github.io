{% assign p = include.product %}
{% assign is_course = false %}
{% assign is_ebook = false %}
{% assign is_pack = false %}
{% if p.type == 'formation' or p.categorie == 'Formation en ligne' %}
  {% assign is_course = true %}
{% endif %}
{% if p.type == 'ebook' or p.file_format == 'pdf' or p.format == 'PDF' %}
  {% assign is_ebook = true %}
{% endif %}
{% if p.type == 'pack' or p.categorie == 'Pack' %}
  {% assign is_pack = true %}
{% endif %}

{% comment %} Utilitaires prix et format {% endcomment %}
{% capture price_num %}{{ p.prix | replace: '€ / HT','' | replace: '/ HT','' | replace: '€ HT','' | replace: '€','' | replace: 'HT','' | strip }}{% endcapture %}
{% capture fmt %}{{ p.format | default: p.file_format | default: '' }}{% endcapture %}
{% comment %} Liste de features: priorise resultats, sinon inclus (pack) {% endcomment %}
{% assign features = p.resultats | default: p.inclus %}
{% comment %} CTA label & activation logic {% endcomment %}
{% assign cta_label = 'Commencer' %}
{% assign has_payment = p.lien_paiement and p.lien_paiement != '' %}
{% assign override_inactive = false %}
{% if p.actif == false or p.active == false or p.enabled == false or p.status == 'inactive' %}{% assign override_inactive = true %}{% endif %}
{% assign is_active = site.shop_enabled and has_payment and override_inactive == false %}

<div class="product-card"
     {% if is_course %}data-type="formation"{% endif %}
     {% if is_ebook %}data-type="ebook"{% endif %}
     {% if is_pack %}data-type="pack"{% endif %}
     data-univers="{{ p.univers | default: '' }}"
     data-categorie="{{ p.categorie | default: '' }}"
     data-niveau="{{ p.niveau | default: '' }}"
     data-format="{{ fmt }}"
     data-price="{{ price_num }}"
     data-duration="{{ p.duree | default: '' }}"
     {% if p.last_update %}data-updated="{{ p.last_update }}"{% endif %}
     {% if p.bestseller %}data-popularity="2"{% else %}data-popularity="0"{% endif %}
     data-name="{{ p.nom | downcase }}">

  {% if p.image %}
  <div class="product-card-image">
    {% if p.univers %}<span class="badge-overlay">{{ p.univers }}</span>{% endif %}
    <img src="{{ site.baseurl }}/{{ p.image }}" alt="Image pour {{ p.nom }}" loading="lazy" decoding="async">
    {% if is_pack %}<span class="card-ribbon">Pack</span>{% endif %}
    {% if p.last_update %}
      <span class="card-tag update" aria-label="Mis à jour le {{ p.last_update | date: '%d/%m/%Y' }}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
        <span class="date">{{ p.last_update | date: "%d/%m/%Y" }}</span>
      </span>
    {% endif %}
  </div>
  {% endif %}

  <div class="product-card-content">
    <h3 class="product-title">{{ p.nom }}</h3>
    <p class="product-description">{{ p.description }}</p>

    <template class="quick-view-content">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">{{ p.nom }}</h3>
        </div>
        <div class="modal-body">
          <div class="modal-grid">
            <div class="modal-media">
              {% if p.image %}
                <img src="{{ site.baseurl }}/{{ p.image }}" alt="{{ p.nom }}" loading="lazy" decoding="async">
              {% endif %}
            </div>
            <div class="modal-main">
              <p class="modal-description">{{ p.description }}</p>
              <ul class="meta-badges">
                {% if p.niveau %}<li class="badge">Niveau: {{ p.niveau }}</li>{% endif %}
                {% if fmt %}<li class="badge">Format: {{ fmt | upcase }}</li>{% endif %}
                {% if p.duree %}<li class="badge">Durée: {{ p.duree }}</li>{% endif %}
                {% if p.garantie %}<li class="badge">Garantie: {{ p.garantie }}</li>{% endif %}
              </ul>
              {% if p.resultats %}
                <h4 class="section-mini">Vous saurez faire</h4>
                <ul class="qv-results">{% for it in p.resultats %}<li>{{ it }}</li>{% endfor %}</ul>
              {% endif %}
              {% if p.programme %}
                <h4 class="section-mini">Programme</h4>
                <ul class="qv-programme">{% for it in p.programme %}<li>{{ it }}</li>{% endfor %}</ul>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="price-chip-lg">{{ p.prix }}</span>
          {% if is_active %}
            <a href="{{ p.lien_paiement }}" class="btn-primary" target="_blank" rel="noopener">Commencer</a>
          {% else %}
            <span class="btn-secondary" aria-disabled="true">Bientôt disponible</span>
          {% endif %}
        </div>
      </div>
    </template>
  </div>

  <div class="card-reveal"></div>

  <div class="product-card-footer">
    <span class="product-price">{{ p.prix }}</span>
    <a href="#" class="btn-primary" data-quickview role="button" aria-haspopup="dialog">En savoir plus</a>
  </div>
</div>



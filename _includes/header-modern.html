<header class="header-executive nav-modern" id="modern-nav">
  <div class="header-container">
    <div class="header-logo nav-brand">
      <a href="{{ "/" | relative_url }}" class="brand-link">
        <img src="/assets/images/logo.png" alt="Nicolas Dabène" class="logo animate-float" width="95" height="95">
      </a>
    </div>
    
    <nav class="header-nav main-navigation">
      <ul class="nav-links" role="menubar" aria-label="Navigation principale">
        {% for item in site.data.navigation %}
          {% unless item.hidden %}
          <li class="nav-item{% if item.subitems %} has-submenu{% endif %}" role="none">
            <a href="{{ item.link | default: '#' | relative_url }}" 
               class="nav-link {% if page.url == item.link %}active{% endif %}" role="menuitem" aria-haspopup="{% if item.subitems %}true{% else %}false{% endif %}" aria-expanded="false">
              {{ item.name }}{% if item.subitems %}<span class="chevron" aria-hidden="true">▾</span>{% endif %}
            </a>
            {% if item.subitems %}
              <ul class="submenu" role="menu">
                {% for sub in item.subitems %}
                  <li class="submenu-item" role="none">
                    <a class="submenu-link" href="{{ sub.link | relative_url }}" role="menuitem">{{ sub.name }}</a>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </li>
          {% endunless %}
        {% endfor %}
      </ul>
    </nav>

    <div class="header-actions nav-actions">
      <a href="{{ "/contact" | relative_url }}" class="btn btn--primary ripple-effect">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="currentColor" stroke-width="2"/>
          <polyline points="22,6 12,13 2,6" stroke="currentColor" stroke-width="2"/>
        </svg>
        Me contacter
      </a>
      
      <button class="mobile-menu-btn" id="mobile-menu-toggle" aria-label="Ouvrir le menu de navigation">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
  </div>

  <script>
  // Improve submenu toggle on focus/hover for accessibility and touch
  document.addEventListener('DOMContentLoaded', function() {
    const itemsWithSubmenu = document.querySelectorAll('.nav-item.has-submenu');
    const closeAll = () => {
      itemsWithSubmenu.forEach(sib => {
        sib.classList.remove('open');
        const sibLink = sib.querySelector('.nav-link');
        sibLink && sibLink.setAttribute('aria-expanded', 'false');
      });
    };

    // Ensure default state is closed
    closeAll();
    itemsWithSubmenu.forEach(item => {
      const link = item.querySelector('.nav-link');
      const submenu = item.querySelector('.submenu');
      if (!link || !submenu) return;

      // Hover (desktop)
      item.addEventListener('mouseenter', () => {
        const hasHover = window.matchMedia('(hover: hover)').matches;
        if (!hasHover) return;
        itemsWithSubmenu.forEach(sib => {
          if (sib !== item) {
            sib.classList.remove('open');
            const sibLink = sib.querySelector('.nav-link');
            sibLink && sibLink.setAttribute('aria-expanded', 'false');
          }
        });
        item.classList.add('open');
        link.setAttribute('aria-expanded', 'true');
      });
      item.addEventListener('mouseleave', (e) => {
        const hasHover = window.matchMedia('(hover: hover)').matches;
        if (!hasHover) return;
        // Keep open if moving into submenu (handled by :hover gap blocker via ::before)
        item.classList.remove('open');
        link.setAttribute('aria-expanded', 'false');
      });

      // Focus within (keyboard)
      item.addEventListener('focusin', () => {
        itemsWithSubmenu.forEach(sib => {
          if (sib !== item) {
            sib.classList.remove('open');
            const sibLink = sib.querySelector('.nav-link');
            sibLink && sibLink.setAttribute('aria-expanded', 'false');
          }
        });
        item.classList.add('open');
        link.setAttribute('aria-expanded', 'true');
      });
      item.addEventListener('focusout', (e) => {
        if (!item.contains(e.relatedTarget)) {
          link.setAttribute('aria-expanded', 'false');
          item.classList.remove('open');
        }
      });

      // Tap toggle (touch)
      let tappedOnce = false;
      link.addEventListener('click', function(e) {
        const hasHover = window.matchMedia('(hover: hover)').matches;
        if (hasHover) return; // default on desktop
        if (!tappedOnce) {
          e.preventDefault();
          tappedOnce = true;
          // Close siblings then open this
          itemsWithSubmenu.forEach(sib => {
            if (sib !== item) {
              sib.classList.remove('open');
              const sibLink = sib.querySelector('.nav-link');
              sibLink && sibLink.setAttribute('aria-expanded', 'false');
            }
          });
          item.classList.add('open');
          link.setAttribute('aria-expanded', 'true');
          setTimeout(() => tappedOnce = false, 700);
        }
      });

      // Close on Escape
      item.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') {
          closeAll();
          link.focus();
        }
      });
    });

    // Close on scroll or click outside
    window.addEventListener('scroll', () => closeAll(), { passive: true });
    document.addEventListener('click', (e) => {
      const within = Array.from(itemsWithSubmenu).some(el => el.contains(e.target));
      if (!within) closeAll();
    });
  });
  </script>

  <!-- Mobile Navigation - Collapsible submenus -->
  <div class="mobile-nav" id="mobile-nav-panel">
    <ul>
      {% for item in site.data.navigation %}
        {% unless item.hidden %}
        <li class="mobile-item{% if item.subitems %} has-submenu{% endif %}">
          <a href="{{ item.link | default: '#' | relative_url }}" class="mobile-nav-link {% if page.url == item.link %}active{% endif %}" aria-expanded="false">
            {{ item.name }}{% if item.subitems %}<span class="chevron" aria-hidden="true">▾</span>{% endif %}
          </a>
          {% if item.subitems %}
            <ul class="mobile-submenu">
              {% for sub in item.subitems %}
                <li><a class="mobile-nav-link mobile-submenu-link" href="{{ sub.link | relative_url }}">{{ sub.name }}</a></li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
        {% endunless %}
      {% endfor %}
      <li><a href="{{ "/contact" | relative_url }}" class="btn btn--primary">Discutons de votre projet</a></li>
    </ul>
  </div>
</header>

<style></style>

<script>
  // JavaScript simple pour la navigation
  document.addEventListener('DOMContentLoaded', function() {
    const nav = document.getElementById('modern-nav');
    const themeToggle = document.getElementById('theme-toggle');
    function updateBodyOffset() {
      if (!nav) return;
      const navHeight = nav.offsetHeight || 72;
      // Publier via variable CSS + scroll-padding, toujours la hauteur réelle
      const offset = navHeight;
      document.documentElement.style.setProperty('--nav-offset', offset + 'px');
      document.documentElement.style.scrollPaddingTop = offset + 'px';
      document.body.style.paddingTop = '';
    }
    
    // Scroll effect
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        nav?.classList.add('scrolled');
      } else {
        nav?.classList.remove('scrolled');
      }
    });
    // Set initial offset and on resize/load
    requestAnimationFrame(updateBodyOffset);
    window.addEventListener('load', updateBodyOffset);
    window.addEventListener('resize', updateBodyOffset);
    // Observe nav size changes (fonts, dynamic content)
    try {
      const ro = new ResizeObserver(updateBodyOffset);
      nav && ro.observe(nav);
    } catch(_) {}

    // Mobile menu toggle - Fixed with debug
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    const mobileNav = document.getElementById('mobile-nav-panel');

    // Debug logs supprimés pour production
    // console.log('Mobile elements found:', {
    //   toggle: !!mobileToggle,
    //   nav: !!mobileNav,
    //   screenWidth: window.innerWidth
    // });

    if (mobileToggle && mobileNav) {
      mobileToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isOpen = mobileNav.classList.contains('open');
        console.log('Menu toggle clicked, currently open:', isOpen);
        
        if (isOpen) {
          mobileNav.classList.remove('open');
          mobileToggle.classList.remove('active');
          document.body.style.overflow = '';
        } else {
          mobileNav.classList.add('open');
          mobileToggle.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
        
        console.log('Menu state after toggle:', mobileNav.classList.contains('open'));
      });
      
      // Close mobile nav when clicking on links (but NOT when opening a submenu)
      const mobileLinks = mobileNav.querySelectorAll('a');
      mobileLinks.forEach(link => {
        link.addEventListener('click', (ev) => {
          const parentItem = link.closest('.mobile-item.has-submenu');
          if (parentItem && !parentItem.classList.contains('open')) {
            // This click will be used to OPEN the submenu (handled below). Do not close panel.
            return;
          }
          mobileNav.classList.remove('open');
          mobileToggle.classList.remove('active');
          document.body.style.overflow = '';
        });
      });
      
      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!mobileNav.contains(e.target) && !mobileToggle.contains(e.target)) {
          mobileNav.classList.remove('open');
          mobileToggle.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
      // Mobile submenu toggle (collapsible)
      const mobileItems = mobileNav.querySelectorAll('.mobile-item.has-submenu');
      mobileItems.forEach(item => {
        const link = item.querySelector('.mobile-nav-link');
        const submenu = item.querySelector('.mobile-submenu');
        if (!link || !submenu) return;

        link.addEventListener('click', function(e){
          const isOpen = item.classList.contains('open');
          if (!isOpen) {
            e.preventDefault();
            mobileItems.forEach(sib => {
              if (sib !== item) {
                sib.classList.remove('open');
                const sLink = sib.querySelector('.mobile-nav-link');
                sLink && sLink.setAttribute('aria-expanded', 'false');
              }
            });
            item.classList.add('open');
            link.setAttribute('aria-expanded', 'true');
          }
        });
      });
    }

    // Theme toggle
    themeToggle?.addEventListener('click', () => {
      const sunIcon = themeToggle.querySelector('.sun');
      const moonIcon = themeToggle.querySelector('.moon');
      
      sunIcon.classList.toggle('hidden');
      moonIcon.classList.toggle('hidden');
      
      document.body.classList.toggle('dark-theme');
    });
  });
</script> 
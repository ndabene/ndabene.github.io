name: Verify Sitemap

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet de dÃ©clencher manuellement
  schedule:
    - cron: '0 8 * * *'  # tous les jours Ã  8h (aprÃ¨s le build)

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Download and Analyze Sitemap
        run: |
          echo "ğŸ“¥ TÃ©lÃ©chargement du sitemap..."

          # Attendre que le site soit dÃ©ployÃ© (si push rÃ©cent)
          sleep 30

          # TÃ©lÃ©charger le sitemap
          SITEMAP_URL="https://nicolas-dabene.fr/sitemap.xml"
          SITEMAP_CONTENT=$(curl -s "$SITEMAP_URL")

          if [ -z "$SITEMAP_CONTENT" ]; then
            echo "âŒ Erreur : Le sitemap est vide ou inaccessible"
            exit 1
          fi

          echo "âœ… Sitemap tÃ©lÃ©chargÃ© avec succÃ¨s"
          echo ""

          # Extraire toutes les URLs
          URLS=$(echo "$SITEMAP_CONTENT" | grep -o '<loc>[^<]*</loc>' | sed 's/<loc>//;s/<\/loc>//')

          # Statistiques globales
          TOTAL=$(echo "$URLS" | wc -l)
          echo "ğŸ“Š STATISTIQUES DU SITEMAP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total d'URLs : $TOTAL"
          echo ""

          # Compter les articles de blog
          BLOG_COUNT=$(echo "$URLS" | grep -c "/articles/" || true)
          echo "ğŸ“ Articles de blog (/articles/) : $BLOG_COUNT"

          # Compter les pages produits
          PRODUCT_COUNT=$(echo "$URLS" | grep -c "/boutique/" || true)
          echo "ğŸ›’ Pages produits (/boutique/) : $PRODUCT_COUNT"

          # Compter les case studies
          CASE_STUDY_COUNT=$(echo "$URLS" | grep -c "/case-studies/" || true)
          echo "ğŸ“‚ Case studies (/case-studies/) : $CASE_STUDY_COUNT"

          # Compter les pages principales
          MAIN_PAGES=$(echo "$URLS" | grep -v "/articles/" | grep -v "/boutique/" | grep -v "/case-studies/" | wc -l)
          echo "ğŸ“„ Pages principales : $MAIN_PAGES"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # VÃ©rifications de cohÃ©rence
          echo ""
          echo "ğŸ” VÃ‰RIFICATIONS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # VÃ©rifier qu'il y a des articles
          if [ "$BLOG_COUNT" -lt 50 ]; then
            echo "âš ï¸  AVERTISSEMENT : Seulement $BLOG_COUNT articles trouvÃ©s (attendu ~54)"
          else
            echo "âœ… Articles de blog : OK ($BLOG_COUNT)"
          fi

          # VÃ©rifier qu'il y a des produits
          if [ "$PRODUCT_COUNT" -eq 0 ]; then
            echo "âŒ ERREUR : Aucune page produit trouvÃ©e (attendu ~239)"
          elif [ "$PRODUCT_COUNT" -lt 200 ]; then
            echo "âš ï¸  AVERTISSEMENT : Seulement $PRODUCT_COUNT pages produits trouvÃ©es (attendu ~239)"
          else
            echo "âœ… Pages produits : OK ($PRODUCT_COUNT)"
          fi

          # VÃ©rifier qu'il y a des case studies
          if [ "$CASE_STUDY_COUNT" -lt 3 ]; then
            echo "âš ï¸  AVERTISSEMENT : Seulement $CASE_STUDY_COUNT case studies trouvÃ©es (attendu 3)"
          else
            echo "âœ… Case studies : OK ($CASE_STUDY_COUNT)"
          fi

          # VÃ©rifier les URLs importantes
          echo ""
          echo "ğŸ” URLs CRITIQUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          for url in "https://nicolas-dabene.fr/" \
                     "https://nicolas-dabene.fr/about/" \
                     "https://nicolas-dabene.fr/boutique/" \
                     "https://nicolas-dabene.fr/youtube/"; do
            if echo "$URLS" | grep -q "^$url$"; then
              echo "âœ… $url"
            else
              echo "âŒ MANQUANT : $url"
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Afficher des exemples d'URLs
          echo ""
          echo "ğŸ“‹ EXEMPLES D'URLS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo ""
          echo "Exemples d'articles :"
          echo "$URLS" | grep "/articles/" | head -3

          if [ "$PRODUCT_COUNT" -gt 0 ]; then
            echo ""
            echo "Exemples de produits :"
            echo "$URLS" | grep "/boutique/" | head -3
          fi

          if [ "$CASE_STUDY_COUNT" -gt 0 ]; then
            echo ""
            echo "Exemples de case studies :"
            echo "$URLS" | grep "/case-studies/" | head -3
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # VÃ©rifier les mÃ©tadonnÃ©es du sitemap
          echo ""
          echo "ğŸ“… DERNIÃˆRES MODIFICATIONS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          LASTMOD=$(echo "$SITEMAP_CONTENT" | grep -o '<lastmod>[^<]*</lastmod>' | sed 's/<lastmod>//;s/<\/lastmod>//' | sort -r | head -1)
          echo "DerniÃ¨re modification dans le sitemap : $LASTMOD"

          echo ""
          echo "âœ… VÃ©rification du sitemap terminÃ©e !"

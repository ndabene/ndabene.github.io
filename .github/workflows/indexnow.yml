name: Notify IndexNow

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 7 * * *'  # tous les jours √† 7h
  workflow_dispatch:  # Permet de d√©clencher manuellement

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Parse Sitemap
        id: sitemap
        run: |
          echo "üì• T√©l√©chargement du sitemap..."

          # T√©l√©charger le sitemap
          SITEMAP_CONTENT=$(curl -s https://nicolas-dabene.fr/sitemap.xml)

          if [ -z "$SITEMAP_CONTENT" ]; then
            echo "‚ùå Erreur : Le sitemap est vide ou inaccessible"
            exit 1
          fi

          echo "‚úÖ Sitemap t√©l√©charg√© avec succ√®s"

          # Extraire toutes les URLs du sitemap
          URLS=$(echo "$SITEMAP_CONTENT" | grep -o '<loc>[^<]*</loc>' | sed 's/<loc>//;s/<\/loc>//')

          # Compter les URLs
          URL_COUNT=$(echo "$URLS" | wc -l)
          echo "üìä Nombre d'URLs trouv√©es dans le sitemap : $URL_COUNT"

          # Convertir en JSON array (limite √† 10000 URLs selon spec IndexNow)
          URL_LIST=$(echo "$URLS" | head -10000 | jq -R -s -c 'split("\n") | map(select(length > 0))')

          # Sauvegarder dans une variable d'environnement
          echo "URL_LIST=$URL_LIST" >> $GITHUB_OUTPUT
          echo "URL_COUNT=$URL_COUNT" >> $GITHUB_OUTPUT

          # Afficher les premi√®res URLs pour v√©rification
          echo ""
          echo "üîç Premi√®res URLs qui seront notifi√©es :"
          echo "$URLS" | head -5

          # Afficher les derni√®res URLs pour v√©rification
          echo ""
          echo "üîç Derni√®res URLs qui seront notifi√©es :"
          echo "$URLS" | tail -5

      - name: Send URLs to IndexNow
        run: |
          echo "üöÄ Envoi de ${{ steps.sitemap.outputs.URL_COUNT }} URLs √† IndexNow..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            -d '{
              "host": "nicolas-dabene.fr",
              "key": "78f5577c5f464d7b920139ca9af76cf4",
              "urlList": ${{ steps.sitemap.outputs.URL_LIST }}
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "üì° Code de r√©ponse HTTP : $HTTP_CODE"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Toutes les URLs ont √©t√© notifi√©es avec succ√®s √† IndexNow !"
            echo "üìä URLs notifi√©es : ${{ steps.sitemap.outputs.URL_COUNT }}"
          elif [ "$HTTP_CODE" -eq 202 ]; then
            echo "‚úÖ URLs accept√©es par IndexNow (202 Accepted)"
            echo "üìä URLs notifi√©es : ${{ steps.sitemap.outputs.URL_COUNT }}"
          else
            echo "‚ö†Ô∏è Code de r√©ponse inattendu : $HTTP_CODE"
            echo "Body: $BODY"
          fi

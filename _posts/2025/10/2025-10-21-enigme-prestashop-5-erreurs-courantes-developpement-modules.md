---
layout: post
title: "üß© √ânigme PrestaShop : Saurez-vous trouver les 5 erreurs ?"
date: 2025-10-21
author: Nicolas Dab√®ne
categories: [PrestaShop, D√©veloppement, PHP, Tutoriel]
tags: [PrestaShop, Module, D√©veloppement, Erreurs, Debug, Hook, Smarty, SQL, Cache]
excerpt: "D√©veloppeurs PrestaShop, je vous lance un d√©fi ! D√©couvrez les 5 erreurs courantes dans ce module de best-sellers et am√©liorez vos comp√©tences de d√©veloppement."
image: /assets/images/blog/2025/10/2025-10-21-enigme-prestashop-erreurs.jpg
featured: true
difficulty: "Interm√©diaire"
technologies: ["PrestaShop", "PHP", "MySQL", "Smarty", "Hook"]
estimated_reading_time: "15 minutes"
is_future: true
---

# üß© √ânigme PrestaShop : Saurez-vous trouver les 5 erreurs ?

D√©veloppeurs PrestaShop, je vous lance un d√©fi ! üöÄ

Vous √™tes pr√™ts √† relever le challenge ? J'ai cr√©√© une √©nigme de **niveau moyen** qui teste vos connaissances sur le d√©veloppement de modules PrestaShop. Le code ci-dessous contient **5 erreurs courantes** que tout d√©veloppeur PrestaShop a probablement d√©j√† rencontr√©es (ou faites üòÖ).

Imaginez-vous comme un d√©tective dans un roman policier. Vous avez devant vous un code apparemment innocent, mais qui cache des myst√®res. Votre mission : identifier les 5 erreurs qui pourraient faire planter votre module en production. Pr√™ts ? C'est parti !

## üéØ Le Contexte de l'√ânigme

Vous devez cr√©er un module qui affiche les produits les plus vendus du mois avec un badge sp√©cial sur la page d'accueil. Rien de tr√®s complexe en apparence, mais comme souvent avec PrestaShop, le diable se cache dans les d√©tails.

Voici le code √† analyser. Prenez votre temps, observez chaque ligne, et notez les erreurs que vous rep√©rez. Je vous donne un indice : ces erreurs sont extr√™mement courantes et peuvent causer des bugs difficiles √† d√©buguer.

## üîç Le Code √† Analyser

```php
class BestSellersModule extends Module
{
    public function __construct()
    {
        $this->name = 'bestsellers';
        $this->tab = 'front_office_features';
        $this->version = '1.0.0';
        $this->author = 'VotreNom';
        
        // ERREUR 1 : Que manque-t-il ici ?
        
        $this->displayName = $this->l('Best Sellers du Mois');
        $this->description = $this->l('Affiche les produits les plus vendus');
    }
    
    public function install()
    {
        // ERREUR 2 : Comment installer correctement un module ?
        return $this->registerHook('displayHome');
    }
    
    public function hookDisplayHome($params)
    {
        // ERREUR 3 : Quelle est la bonne fa√ßon de r√©cup√©rer le contexte ?
        $id_lang = $this->context->language->id;
        $id_shop = $this->context->shop->id;
        
        $bestSellers = $this->getBestSellers($id_lang, $id_shop);
        
        // ERREUR 4 : Comment assigner correctement des variables √† Smarty ?
        $this->smarty->assign('products', $bestSellers);
        
        // ERREUR 5 : Quel est le bon chemin pour le template ?
        return $this->display(__FILE__, 'bestsellers.tpl');
    }
    
    protected function getBestSellers($id_lang, $id_shop, $limit = 10)
    {
        $sql = new DbQuery();
        $sql->select('p.id_product, pl.name, p.price')
            ->from('product', 'p')
            ->leftJoin('product_lang', 'pl', 
                'p.id_product = pl.id_product AND pl.id_lang = ' . (int)$id_lang)
            ->leftJoin('order_detail', 'od', 'p.id_product = od.product_id')
            ->where('p.active = 1')
            ->where('p.id_shop = ' . (int)$id_shop)
            ->groupBy('p.id_product')
            ->orderBy('SUM(od.product_quantity) DESC')
            ->limit($limit);
        
        return Db::getInstance()->executeS($sql);
    }
}
```

Alors, les avez-vous trouv√©es ? Ne vous inqui√©tez pas si vous n'avez pas tout rep√©r√© du premier coup. M√™me les d√©veloppeurs exp√©riment√©s peuvent passer √† c√¥t√© de ces erreurs classiques. Avant de vous donner les solutions, laissez-moi vous expliquer pourquoi ces erreurs sont si importantes.

## ü§î Pourquoi ces erreurs sont cruciales ?

Dans le d√©veloppement PrestaShop, certaines erreurs peuvent sembler anodines mais avoir des cons√©quences dramatiques :

- Une erreur d'initialisation peut faire planter tout votre module
- Un probl√®me de contexte peut causer des bugs impr√©visibles selon l'environnement
- Une mauvaise gestion des templates peut emp√™cher l'affichage
- Des probl√®mes SQL peuvent ralentir votre boutique ou afficher des donn√©es incorrectes

C'est comme construire une maison : si les fondations sont mal faites, tout l'√©difice risque de s'effondrer. Maintenant, d√©couvrons ensemble les solutions.

## ‚úÖ LES SOLUTIONS D√âTAILL√âES

### **Erreur 1 : `parent::__construct()` manquant - L'oubli fatal**

```php
public function __construct()
{
    $this->name = 'bestsellers';
    $this->tab = 'front_office_features';
    $this->version = '1.0.0';
    $this->author = 'VotreNom';
    
    parent::__construct(); // ‚úÖ INDISPENSABLE
    
    $this->displayName = $this->l('Best Sellers du Mois');
    $this->description = $this->l('Affiche les produits les plus vendus');
}
```

**Pourquoi cette erreur est critique ?**

Imaginez que vous construisez une voiture. Vous assemblez le moteur, les roues, la carrosserie, mais vous oubliez de connecter la batterie. La voiture aura l'air parfaite, mais elle ne d√©marrera jamais !

`parent::__construct()` joue exactement ce r√¥le de "batterie" dans PrestaShop. Il :
- Initialise le contexte (`$this->context`)
- Configure l'environnement Smarty
- Pr√©pare les traductions (`$this->l()`)
- Initialise toutes les propri√©t√©s essentielles

**Cons√©quence si omis :** Erreur fatale "Call to undefined method" ou "Undefined property" d√®s que vous utilisez `$this->context` ou `$this->l()`.

**R√®gle d'or :** `parent::__construct()` doit TOUJOURS √™tre appel√© en premier dans votre constructeur.

---

### **Erreur 2 : `parent::install()` non appel√© - Le module fant√¥me**

```php
public function install()
{
    return parent::install() // ‚úÖ Enregistre le module en BDD
        && $this->registerHook('displayHome');
}
```

**L'analogie du restaurant :**

Vous voulez ouvrir un restaurant. Vous choisissez l'emplacement, d√©corez l'int√©rieur, embauchez le personnel, mais vous oubliez de demander la licence d'exploitation. Votre restaurant peut cuisiner les meilleurs plats du monde, personne ne le saura jamais car il n'existe pas officiellement !

`parent::install()` enregistre votre module dans la base de donn√©es de PrestaShop :
- Il cr√©e l'entr√©e dans la table `ps_module`
- Il d√©finit le statut d'activation
- Il permet √† PrestaShop de "voir" votre module

**Cons√©quence si omis :** Le module semble install√©, mais n'appara√Æt pas dans la liste des modules, et les hooks ne fonctionnent pas.

**R√®gle d'or :** Toujours retourner `parent::install() && [vos conditions]`.

---

### **Erreur 3 : Acc√®s au contexte - Le GPS d√©faillant**

```php
public function hookDisplayHome($params)
{
    $context = Context::getContext(); // ‚úÖ Bonne pratique
    $id_lang = $context->language->id;
    $id_shop = $context->shop->id;
    
    // OU : $id_lang = $this->context->language->id;
    // (possible seulement apr√®s parent::__construct())
```

**L'analogie du GPS :**

Vous partez en voyage avec votre GPS, mais vous ne l'allumez pas. Vous connaissez votre destination, vous avez la carte, mais vous ne savez pas o√π vous √™tes actuellement. R√©sultat : vous tournez en rond !

Le contexte PrestaShop contient toutes les informations sur l'environnement actuel :
- Langue courante
- Boutique active (dans le multi-boutique)
- Client connect√©
- Devise utilis√©e
- Etc.

**Pourquoi `Context::getContext()` est pr√©f√©rable :**
- Il fonctionne partout, m√™me en dehors des classes Module
- Il est plus fiable que `$this->context` dans certains cas
- Il suit les bonnes pratiques PrestaShop

**Cons√©quence si mal utilis√© :** Bugs impr√©visibles selon l'environnement (langue incorrecte, mauvaise boutique, etc.).

---

### **Erreur 4 : Assignation Smarty incorrecte - Le livreur distrait**

```php
$this->context->smarty->assign(array(
    'products' => $bestSellers
)); // ‚úÖ Format tableau
```

**L'analogie du livreur :**

Vous commandez une pizza et dites au livreur : "Voici l'adresse : 123 rue de la Paix. Et aussi, n'oubliez pas de sonner deux fois." Mais vous ne lui dites pas quelle pizza commander !

Smarty attend un tableau associatif complet avec toutes les variables, pas des appels individuels. C'est comme donner une liste de courses compl√®te d'un coup plut√¥t que d'appeler le magasin pour chaque article.

**Pourquoi c'est important :**
- Performance : Un seul appel plut√¥t que plusieurs
- Lisibilit√© : Toutes les variables au m√™me endroit
- Maintenance : Plus facile √† d√©boguer

**Cons√©quence si mal fait :** Variables non transmises au template, affichage incorrect.

---

### **Erreur 5 : Chemin du template incorrect - L'adresse perdue**

```php
return $this->display(__FILE__, 'views/templates/hook/bestsellers.tpl'); // ‚úÖ
```

**L'analogie du facteur :**

Vous envoyez une lettre importante, mais vous √©crivez l'adresse de destinataire sur l'enveloppe au lieu d'utiliser l'adresse correcte. Le facteur ne saura pas o√π la livrer !

PrestaShop suit une convention de nommage tr√®s stricte pour les templates :
- `views/templates/hook/` pour les templates de hooks
- `views/templates/admin/` pour les templates d'administration
- `views/templates/front/` pour les contr√¥leurs front-office

**Pourquoi cette structure :**
- Organisation logique du code
- Compatibilit√© avec les th√®mes enfants
- Mises √† jour plus faciles

**Cons√©quence si mal fait :** Template non trouv√©, erreur d'affichage.

## üí° Questions Bonus pour les Experts

Maintenant que nous avons corrig√© les erreurs de base, passons aux optimisations pour les d√©veloppeurs confirm√©s !

### **1. Comment optimiseriez-vous la requ√™te SQL ?**

```php
protected function getBestSellersOptimized($id_lang, $id_shop, $limit = 10)
{
    // Calculer le mois en cours
    $date_from = date('Y-m-01'); // Premier jour du mois
    $date_to = date('Y-m-t');   // Dernier jour du mois
    
    $sql = new DbQuery();
    $sql->select('p.id_product, pl.name, p.price, SUM(od.product_quantity) as total_sold')
        ->from('product', 'p')
        ->innerJoin('product_lang', 'pl', 'p.id_product = pl.id_product AND pl.id_lang = ' . (int)$id_lang)
        ->innerJoin('order_detail', 'od', 'p.id_product = od.product_id')
        ->innerJoin('orders', 'o', 'od.id_order = o.id_order')
        ->where('p.active = 1')
        ->where('p.id_shop = ' . (int)$id_shop)
        ->where('o.valid = 1') // ‚úÖ Seulement les commandes valid√©es
        ->where('o.date_add >= "' . pSQL($date_from) . '"')
        ->where('o.date_add <= "' . pSQL($date_to) . '"')
        ->groupBy('p.id_product')
        ->orderBy('SUM(od.product_quantity) DESC')
        ->limit($limit);
    
    // Utiliser le serveur esclave pour les lectures
    return Db::getInstance(_PS_USE_SQL_SLAVE_)->executeS($sql);
}
```

**Optimisations apport√©es :**
- **Filtrage par mois** : Seules les ventes du mois en cours
- **Commandes valid√©es uniquement** : √âvite de compter les commandes annul√©es
- **INNER JOIN** : Plus performant que LEFT JOIN quand on veut des r√©sultats
- **Serveur esclave** : R√©duit la charge sur le serveur ma√Ætre

---

### **2. Comment ajouteriez-vous un syst√®me de cache ?**

```php
public function hookDisplayHome($params)
{
    // Cr√©er un ID de cache unique
    $cache_id = $this->getCacheId('bestsellers_' . $this->context->shop->id . '_' . $this->context->language->id);
    
    // V√©rifier si le cache existe
    if (!$this->isCached('views/templates/hook/bestsellers.tpl', $cache_id)) {
        // Si pas en cache, r√©cup√©rer les donn√©es
        $bestSellers = $this->getBestSellers(
            $this->context->language->id, 
            $this->context->shop->id
        );
        
        // Formater les donn√©es pour le template
        $this->context->smarty->assign(array(
            'products' => $bestSellers,
            'module_name' => $this->name
        ));
    }
    
    // Retourner le template (en cache ou non)
    return $this->display(__FILE__, 'views/templates/hook/bestsellers.tpl', $cache_id);
}
```

**Avantages du cache :**
- **Performance** : √âvite les requ√™tes SQL r√©p√©t√©es
- **√âvolutif** : Supporte la multi-boutique et multi-langue
- **Automatique** : PrestaShop vide le cache lors des changements importants

---

### **3. Que devriez-vous faire dans la m√©thode `uninstall()` ?**

```php
public function uninstall()
{
    // D√©senregistrer les hooks
    $this->unregisterHook('displayHome');
    
    // Supprimer les configurations personnalis√©es
    Configuration::deleteByName('BESTSELLERS_LIMIT');
    Configuration::deleteByName('BESTSELLERS_SHOW_PRICE');
    
    // Nettoyer les √©ventuels fichiers temporaires
    // (si votre module en cr√©e)
    
    // Appeler le parent pour finaliser
    return parent::uninstall();
}
```

**Pourquoi c'est crucial :**
- **Propret√©** : √âvite les donn√©es orphelines
- **S√©curit√©** : Supprime les acc√®s potentiels
- **Maintenance** : Facilite les r√©installations

---

### **4. Comment rendre le nombre de produits configurable ?**

Dans `getContent()` (m√©thode appel√©e depuis le back-office) :

```php
public function getContent()
{
    $output = '';
    
    // Traitement du formulaire
    if (Tools::isSubmit('submit_' . $this->name)) {
        $limit = (int)Tools::getValue('BESTSELLERS_LIMIT');
        if ($limit > 0 && $limit <= 50) {
            Configuration::updateValue('BESTSELLERS_LIMIT', $limit);
            $output .= $this->displayConfirmation($this->l('Configuration mise √† jour'));
        } else {
            $output .= $this->displayError($this->l('Valeur invalide'));
        }
    }
    
    // Affichage du formulaire avec HelperForm
    $helper = new HelperForm();
    // Configuration du helper...
    
    $fields_form = array(
        'form' => array(
            'legend' => array('title' => $this->l('Configuration')),
            'input' => array(
                array(
                    'type' => 'text',
                    'label' => $this->l('Nombre de produits'),
                    'name' => 'BESTSELLERS_LIMIT',
                    'required' => true,
                    'desc' => $this->l('Maximum 50 produits')
                )
            ),
            'submit' => array('title' => $this->l('Enregistrer'))
        )
    );
    
    $helper->fields_value = array(
        'BESTSELLERS_LIMIT' => Configuration::get('BESTSELLERS_LIMIT', 10)
    );
    
    return $output . $helper->generateForm(array($fields_form));
}
```

---

### **5. Quelle m√©thode utiliser pour formatter les prix ?**

```php
// M√©thode recommand√©e depuis PrestaShop 1.7.6
public function formatPrice($price, $id_currency = null)
{
    $context = Context::getContext();
    $id_currency = $id_currency ?: $context->currency->id;
    $currency = new Currency($id_currency);
    
    return $context->getCurrentLocale()->formatPrice(
        $price, 
        $currency->iso_code
    );
}

// OU utiliser Product::getProductsProperties pour formatter automatiquement
public function hookDisplayHome($params)
{
    $bestSellers = $this->getBestSellers($this->context->language->id, $this->context->shop->id);
    
    // R√©cup√©rer les propri√©t√©s compl√®tes des produits (avec prix format√©s)
    $products = Product::getProductsProperties(
        $this->context->language->id, 
        $bestSellers
    );
    
    $this->context->smarty->assign('products', $products);
    return $this->display(__FILE__, 'views/templates/hook/bestsellers.tpl');
}
```

**‚ö†Ô∏è ATTENTION IMPORTANTE :**
`Tools::displayPrice()` est **d√©pr√©ci√©e depuis PrestaShop 1.7.6** et ne doit plus √™tre utilis√©e. Pr√©f√©rez toujours `$context->getCurrentLocale()->formatPrice()`.

## üéì Conclusion : L'importance des bonnes pratiques

Cette √©nigme vous aura montr√© que le d√©veloppement PrestaShop n'est pas seulement une question de code, mais aussi de rigueur et de connaissance des bonnes pratiques. Ces 5 erreurs sont :

1. **parent::__construct()** - La fondation invisible
2. **parent::install()** - L'enregistrement officiel  
3. **Context::getContext()** - L'environnement actuel
4. **assign(array(...))** - La transmission des donn√©es
5. **views/templates/hook/** - L'organisation des fichiers

**Le√ßon √† retenir :** Dans PrestaShop, les d√©tails comptent √©norm√©ment. Une petite erreur peut faire la diff√©rence entre un module qui fonctionne parfaitement et un qui cause des nuits blanches au d√©bogage.

N'h√©sitez pas √† partager vos r√©ponses dans les commentaires, ou √† proposer vos propres √©nigmes ! Et souvenez-vous : m√™me les meilleurs d√©veloppeurs ont d√©j√† fait ces erreurs. C'est en les corrigeant qu'on progresse.

**Question bonus pour vous :** Quelle est votre erreur PrestaShop la plus m√©morable ? Partagez-la en commentaires pour aider la communaut√© ! üöÄ

---

*Retrouvez d'autres tutoriels PrestaShop sur [mon blog](/) et n'h√©sitez pas √† me suivre sur [LinkedIn](https://www.linkedin.com/in/nicolasdabene/) pour plus de contenu technique !*
